<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <title>查詢結果</title>
    <link rel="stylesheet" href="CSS/index.css">
</head>

<body>

    <div class="total">

        <div class="top-row">
            

            <p><a href="Home.html" target="_self" class="verification-button"><img src="image/home.png" alt=""></a></p>

            <button id="login-signup"></button>
        </div>

        <div class="datePickerValue">
            <h5 id="selectedDatePlaceholder"></h5>
        </div>

        <div class="droplist">
            <div class="select-menu">
                <div class="select-btn">
                    <span class="sBtn-text">顯示所有教室</span>
                    <img class="sBtn-img" src="image/dropdownIcon.png">
                </div>

                <ul class="options">
                    <li class="option">
                        <span class="option-text">顯示所有教室</span>
                    </li>
                    <li class="option">
                        <span class="option-text">選擇特定時段</span>
                    </li>
                    <li class="option">
                        <span class="option-text">輸入教室名稱</span>
                    </li>
                </ul>
            </div>

            <div class="query">
                <input class="blank" type="text" placeholder="" disabled>

                <input class="inputClassRoomName" type="text" placeholder="輸入教室名稱" list="classroomNameList">
                <datalist id="classroomNameList">
                    <option>INS101</option>
                    <option>INS105</option>
                    <option>INS203</option>
                    <option>INS205</option>
                    <option>INS212</option>
                    <option>INS301</option>
                    <option>INS303</option>
                    <option>INS407</option>
                    <option>INS409</option>
                    <option>ECGB107</option>
                    <option>ECG607</option>
                    <option>ECG610</option>
                </datalist>

                <div class="inputTimeInterval">
                    <div class="selectTime">
                        <input class="time" type="text" id="time1" placeholder="開始時間" readonly>
                        <div class="dropdownStart">
                            <ul class="startList">
                                <li>09:00</li>
                                <li>10:00</li>
                                <li>11:00</li>
                                <li>12:00</li>
                                <li>13:00</li>
                                <li>14:00</li>
                                <li>15:00</li>
                                <li>16:00</li>
                                <li>17:00</li>
                                <li>18:00</li>
                                <li>19:00</li>
                            </ul>
                        </div>
                    </div>

                    <img class="queryImage" src="image/right.png" alt="Query">
                    <div class="selectTime">
                        <input class="time" type="text" id="time2" placeholder="結束時間" readonly disabled>
                        <div class="dropdownEnd">
                            <ul class="endList">
                            </ul>
                        </div>
                    </div>
                </div>
                <form method="get" id="form">
                    <button type="submit" class="queryButton" disabled>
                        <img class="queryImage" src="image/queryIcon.png" alt="Query">
                    </button>
                </form>
            </div>

        </div>

        <div class="content-container">
            <div class="text" id="showClassroom">
                <!-- <h1>以下是查詢的教室目前狀態</h1> -->
            </div>


            <!-- 彈跳視窗內容 -->
            <div id="popup" class="popup">
                <h1>XXX教室</h1>
                <button type="button" onclick="closePopupClassroom()" class="close">
                    <img src="image/close.png" alt="Close">
                </button>
                <div class="content">
                    <span>起始時間</span><span>結束時間</span><span>借用狀態</span>
                    <div class="wrap"></div>
                    <span>9 a.m.</span><span>10 a.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>10 a.m.</span><span>11 a.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>11 a.m.</span><span>12 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>12 p.m.</span><span>13 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>13 p.m.</span><span>14 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>14 p.m.</span><span>15 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>15 p.m.</span><span>16 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>16 p.m.</span><span>17 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>17 p.m.</span><span>18 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>18 p.m.</span><span>19 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <span>19 p.m.</span><span>20 p.m.</span><span onclick="CheckAuthentication()"
                        class="classroomState">未借用</span>
                    <div class="wrap"></div>
                    <!-- <p></p>
            <p></p> -->
                </div>
            </div>
        </div>
    </div>
    <script>
        //獲取使用者身分
        let user = {
            username: "",
            useraccount: "",
            email: "",
            phone: null
        };
        fetch("獲取身分資訊.php")
        .then(response => response.json())
        .then(data => {
            if(data.error === undefined) {
                user = data;
                document.getElementById("login-signup").innerHTML = "<img src='image/usericon.png'>" + user.username;
                document.getElementById("login-signup").addEventListener("click", function (event) {
                    window.location.href = "使用者介面.html";
                }, false);
            }
            else {
                //沒有登入就回首頁
                window.alert("請先登入！");
                window.location.href = "Home.html";
            }
        });

        // 獲取查詢的日期值
        const selectedDate = localStorage.getItem("selectedDate");
        if (selectedDate) {
            document.getElementById("selectedDatePlaceholder").textContent = selectedDate + " 教室狀態查詢結果";
        }

        // 大部分功能
        const optionMenu = document.querySelector(".select-menu"),
            selectBtn = optionMenu.querySelector(".select-btn"),
            options = optionMenu.querySelectorAll(".option"),
            sBtn_text = optionMenu.querySelector(".sBtn-text"),
            queryBlank = document.querySelector(".blank"),
            queryClassRoom = document.querySelector(".inputClassRoomName"),
            queryTimeInterval = document.querySelector(".inputTimeInterval");

        //以後會被資料庫所取代
        let allClassroomName = [];
        const startTime = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00"],
            endTime = ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00"],
            condition = [0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1];

        fetch("獲取教室名稱.php")
            .then(response => response.json())
            .then(datas => {
                datas.forEach((data) => {
                    allClassroomName.push(data[0]);
                });
                showDefault();
            });

        //列出所有教室狀態
        function showDefault() {
            let content = "";
            content += '<span style="width: 70px;">教室名稱</span><span class="gap">教室位置</span>\
            <span>借用情況</span><div class="wrap"></div>';

            allClassroomName.forEach((classroom) => {
                content += `<span onclick="showPopupClassroom()" class="classroomName">${classroom}</span><span class="gap">\
                    ${classroom.slice(0, 3) == "INS" ? "電資大樓" : "電綜大樓"}</span><div class="totalBar">\
                    <div class="nowState-bar">30%</div></div><div class="wrap"></div>`;
            });
            document.getElementById("showClassroom").innerHTML = content;
        }

        //下拉式選單
        //選完開始才可以選結束時間
        document.querySelectorAll(".startList li").forEach((item) => {
            item.addEventListener("click", () => {
                document.getElementById("time1").value = item.textContent;
                document.getElementById("time2").removeAttribute("disabled");
                document.getElementById("time2").value = "";
                //讓結束時間可以保持必定比開始時間大
                let i = startTime.indexOf(document.getElementById("time1").value);
                let myList = document.querySelector(".endList");
                myList.innerHTML = "";
                endTime.slice(i).forEach((time) => {
                    let newItem = document.createElement("li");
                    newItem.textContent = time;
                    //更新endList的eventlistener
                    newItem.addEventListener("click", () => {
                        document.getElementById("time2").value = newItem.textContent;
                    })
                    myList.appendChild(newItem);
                })
            })
        })
        document.getElementById("time1").addEventListener("click", () => {
            event.stopPropagation();
            let temp = document.querySelector(".dropdownStart");
            temp.style.display = temp.style.display === "block" ? "none" : "block";
            document.querySelector(".dropdownEnd").style.display = "none";
            optionMenu.classList.remove("active");
        })
        document.getElementById("time2").addEventListener("click", () => {
            event.stopPropagation();
            let temp = document.querySelector(".dropdownEnd");
            temp.style.display = temp.style.display === "block" ? "none" : "block";
            document.querySelector(".dropdownStart").style.display = "none";
            optionMenu.classList.remove("active");
        })
        document.addEventListener("click", (event) => {
            let a = document.querySelector(".dropdownStart"),
                b = document.querySelector(".dropdownEnd");
            a.style.display = "none";
            b.style.display = "none";
            optionMenu.classList.remove("active");
        })

        //顯示以教室名稱或特定時段搜尋的結果
        form.addEventListener("submit", () => {
            event.preventDefault();
            let properClassroomName = false,
                intervalVacant = true,
                queryStartTime = document.getElementById("time1").value,
                queryEndTime = document.getElementById("time2").value;

            for (let i = 0; i < allClassroomName.length; i++) {
                if (queryClassRoom.value == allClassroomName[i]) properClassroomName = true;
            }

            if (properClassroomName) {
                document.getElementById("showClassroom").innerHTML = '<span>教室名稱</span><span class="gap">教室位置</span><span>借用情況</span>';
                document.getElementById("showClassroom").innerHTML += '<div class="wrap"></div><span onclick="showPopupClassroom()" class="classroomName">XXX教室</span><span class="gap">' + queryClassRoom.value + '</span><div class="totalBar"><div class="nowState-bar">30%</div></div>';
                queryClassRoom.value = "";
            }
            else if (queryStartTime != "" && queryEndTime != "" && queryStartTime < queryEndTime) {
                document.getElementById("showClassroom").innerHTML = '<span>教室名稱</span><span class="gap">教室位置</span><span>借用情況</span>';
                for (let i = 0; i < allClassroomName.length; i++) {
                    for (let j = 0; j < startTime.length; j++) {
                        if (startTime[j] >= queryStartTime && endTime[j] <= queryEndTime && condition[j] == 0) {
                            intervalVacant = false;
                            break;
                        }
                    }
                    if (intervalVacant) {
                        document.getElementById("showClassroom").innerHTML += '<div class="wrap"></div><span onclick="showPopupClassroom()" class="classroomName">XXX教室</span><span class="gap">' + allClassroomName[i] + '</span><div class="totalBar"><div class="nowState-bar">30%</div></div>';
                    }
                    intervalVacant = true;
                }
                document.getElementById("time1").value = "";
                document.getElementById("time2").value = "";
                document.getElementById("time2").setAttribute("disabled", true);
            }
        })

        selectBtn.addEventListener("click", () => {
            event.stopPropagation();
            optionMenu.classList.toggle("active");
        });

        options.forEach(option => {
            option.addEventListener("click", () => {
                let selectedOption = option.querySelector(".option-text").innerText;
                sBtn_text.innerText = selectedOption;

                if (selectedOption === "輸入教室名稱") {
                    queryBlank.style.display = "none";
                    queryClassRoom.style.display = "flex";
                    queryTimeInterval.style.display = "none";
                    queryBlank.removeAttribute("disabled");
                    document.querySelector(".queryButton").removeAttribute("disabled");
                }
                else if (selectedOption === "選擇特定時段") {
                    queryBlank.style.display = "none";
                    queryClassRoom.style.display = "none";
                    queryTimeInterval.style.display = "flex";
                    queryBlank.removeAttribute("disabled");
                    document.querySelector(".queryButton").removeAttribute("disabled");
                }
                else {
                    queryBlank.style.display = "flex";
                    queryClassRoom.style.display = "none";
                    queryTimeInterval.style.display = "none";
                    queryBlank.setAttribute("disabled", true);
                    document.querySelector(".queryButton").setAttribute("disabled", true);
                    showDefault();
                }

                optionMenu.classList.remove("active");
            })
        })

        //彈跳視窗
        let popup = document.getElementById("popup");

        // 點擊教室開啟彈跳視窗的函數
        function showPopupClassroom() {
            popup.classList.add("open-popup");
        }

        function closePopupClassroom() {
            popup.classList.remove("open-popup");
        }

        //檢查是否登入
        function CheckAuthentication() {

            //缺少檢查函數

            window.location.href = "選擇登入身分.html"
        }

    </script>

</body>

</html>